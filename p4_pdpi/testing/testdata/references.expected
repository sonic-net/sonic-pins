=========================================================================
OutgoingConcreteTableReferences: Fails if entity does not belong to source table
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "wrong_table"
    table_id: 7
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
INVALID_ARGUMENT: Provided table entry had id 50151603 but IrP4Table had id 7

=========================================================================
OutgoingConcreteTableReferences: Fails if entity is missing non-optional field
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "missing_field"
        field_id: 7
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
INVALID_ARGUMENT: Missing EXACT match field value for field_name: "missing_field" field_id: 7 in entity:
 table_id: 50151603
match {
  field_id: 1
  exact {
    value: "key-a"
  }
}
match {
  field_id: 2
  exact {
    value: "key-b"
  }
}
action {
  action {
    action_id: 31939749
    params {
      param_id: 1
      value: "arg1"
    }
    params {
      param_id: 2
      value: "arg2"
    }
  }
}


=========================================================================
OutgoingConcreteTableReferences: Fails if entity refers to optional field
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key_1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
UNIMPLEMENTED: References to optional fields are not supported.
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key_1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
}


=========================================================================
OutgoingConcreteTableReferences: Fails for unsupported reference type (i.e. P4MatchField-Refers-To-P4ActionField)
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "other_arg"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
UNIMPLEMENTED: Unsupported field reference from IrField match_field { p4_match_field { field_name: "key1" field_id: 1 } } to IrField action_field { p4_action_field { action_name: "other_action" parameter_name: "other_arg" } }

=========================================================================
OutgoingConcreteTableReferences: No field references creates no concrete references
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}

-- OUTPUT -------------------------------------------------------------
<empty>

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-P4MatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-P4MatchField reference creates a single concrete reference for present optional field.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-P4MatchField reference creates no concrete reference for absent optional field.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        field_id: 7
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
<empty>

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-BuiltInMatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'multicast_group_id', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInMatchField-Refers-To-P4MatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'other_field', value: '7' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInMatchField-Refers-To-BuiltInMatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4ActionField-Refers-To-P4MatchField reference creates a concrete reference for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4ActionField-Refers-To-BuiltInMatchField reference creates a concrete reference for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'multicast_group_id', value: 'act1-arg1' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'multicast_group_id', value: 'act2-arg1' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInActionField-Refers-To-P4MatchField reference creates a concrete reference for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'other_field', value: 'port_1' },
  }
}
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'other_field', value: 'port_2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInActionField-Refers-To-BuiltInMatchField reference creates a concrete reference for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'multicast_group_id', value: 'port_1' },
  }
}
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'multicast_group_id', value: 'port_2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInActionField-Refers-To-P4MatchField reference creates a concrete reference for every instance of the backup-action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
        backup_replicas {
          port: "port_3"
          instance: "0x0033"
        }
        backup_replicas {
          port: "port_4"
          instance: "0x0034"
        }
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
        backup_replicas {
          port: "port_5"
          instance: "0x0035"
        }
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'other_field', value: 'port_1' },
  }
}
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'other_field', value: 'port_2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInActionField-Refers-To-BuiltInMatchField reference creates a concrete reference for every instance of the backup-action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
        backup_replicas {
          port: "port_3"
          instance: "0x0033"
        }
        backup_replicas {
          port: "port_4"
          instance: "0x0034"
        }
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
        backup_replicas {
          port: "port_5"
          instance: "0x0035"
        }
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'multicast_group_id', value: 'port_1' },
  }
}
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'multicast_group_id', value: 'port_2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: Multi P4MatchField-Refers-To-MatchField references create a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
    ConcreteFieldReference{ source field: 'key2', destination field: 'other_field', value: 'key-b' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: Two P4MatchField-Refers-To-MatchField references including optional create a single concrete reference with 2 ConcreteFieldReferences if optional is present.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
    ConcreteFieldReference{ source field: 'key2', destination field: 'other_field', value: 'key-b' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: Two P4MatchField-Refers-To-MatchField references including optional create a single concrete reference with 1 ConcreteFieldReference if optional is absent.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: Multi P4ActionField-Refers-To-MatchField references for the same action create a concrete reference containing all fields for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg2"
        parameter_id: 2
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg2', destination field: 'other_field', value: 'act1-arg2' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg2', destination field: 'other_field', value: 'act2-arg2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: Multi P4ActionField-Refers-To-MatchField references for the different actions create a concrete reference containing respective fields for every instance of the respective action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_golden_test_friendly_action"
        action_id: 25225410
        parameter_name: "arg2"
        parameter_id: 2
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_golden_test_friendly_action.arg2', destination field: 'other_field', value: 'act3-arg2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-MatchField + P4ActionField-Refers-To-MatchField references create a concrete reference for every action (including action with no reference info).
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-MatchField + P4ActionField-Refers-To-MatchField references including optional create a concrete reference for every action (including action with no reference info) if optional present.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-MatchField + P4ActionField-Refers-To-MatchField references including optional create a concrete reference for every action (except action with no reference info) if optional absent.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act1-arg1"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "act2-arg1"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
  wcmp_actions {
    action {
      other_golden_test_friendly_action {
        arg1: "act3-arg1"
        arg2: "act3-arg2"
      }
    }
    weight: 3
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act1-arg1' },
  }
}
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'act2-arg1' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInMatchField-Refers-To-MatchField + BuiltInActionField-Refers-To-MatchField references create a concrete reference for every instance of the action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_1"
        instance: "0x0031"
      }
      replicas {
        port: "port_2"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "some_other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'other_field', value: '7' },
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'some_other_field', value: 'port_1' },
  }
}
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'other_field', value: '7' },
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'some_other_field', value: 'port_2' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: P4MatchField-Refers-To-MatchField + P4ActionField-Refers-To-MatchField references create a single concrete reference for match fields when no actions are present
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: BuiltInMatchField-Refers-To-MatchField + BuiltInActionField-Refers-To-MatchField references create a single concrete reference for match fields when no actions are present
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "some_other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'other_field', value: '7' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: A single reference is created for P4 actions with duplicate referring values.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_wcmp_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "arg-dupe"
        arg2: "act1-arg2"
      }
    }
    weight: 1
  }
  wcmp_actions {
    action {
      golden_test_friendly_action {
        arg1: "arg-dupe"
        arg2: "act2-arg2"
      }
    }
    weight: 2
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "golden_test_friendly_wcmp_table"
    table_id: 37604604
  }
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'golden_test_friendly_wcmp_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'golden_test_friendly_action.arg1', destination field: 'other_field', value: 'arg-dupe' },
    ConcreteFieldReference{ source field: 'key1', destination field: 'other_field', value: 'key-a' },
  }
}

=========================================================================
OutgoingConcreteTableReferences: A single reference is created for built-in actions with duplicate referring values.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port_dupe"
        instance: "0x0031"
      }
      replicas {
        port: "port_dupe"
        instance: "0x0032"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  p4_table {
    table_name: "other_table"
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "some_other_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'other_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'other_field', value: '7' },
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'some_other_field', value: 'port_dupe' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Fails if entity does not belong to destination table
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "wrong_table"
    table_id: 7
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
INVALID_ARGUMENT: Provided table entry had id 50151603 but IrP4Table had id 7

=========================================================================
PossibleIncomingConcreteTableReferences: Fails if referenced field is missing
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "some_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "missing_field"
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
INVALID_ARGUMENT: Missing EXACT match field value for field_name: "missing_field" in entity:
 table_id: 50151603
match {
  field_id: 1
  exact {
    value: "key-a"
  }
}
match {
  field_id: 2
  exact {
    value: "key-b"
  }
}
action {
  action {
    action_id: 31939749
    params {
      param_id: 1
      value: "arg1"
    }
    params {
      param_id: 2
      value: "arg2"
    }
  }
}


=========================================================================
PossibleIncomingConcreteTableReferences: Fails if referenced field is optional
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "some_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key_1"
        is_optional: true
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
UNIMPLEMENTED: References to optional fields are not supported.
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "some_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key_1"
        is_optional: true
      }
    }
  }
}


=========================================================================
PossibleIncomingConcreteTableReferences: Fails for unsupported reference type (i.e. Action-Referenced-By-Action)
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "other_arg"
      }
    }
  }
  destination {
    action_field {
      p4_action_field {
        action_name: "golden_test_friendly_action"
        action_id: 31939749
        parameter_name: "arg1"
        parameter_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
UNIMPLEMENTED: Unsupported field reference from IrField action_field { p4_action_field { action_name: "other_action" parameter_name: "other_arg" } } to IrField action_field { p4_action_field { action_name: "golden_test_friendly_action" action_id: 31939749 parameter_name: "arg1" parameter_id: 1 } }

=========================================================================
PossibleIncomingConcreteTableReferences: No field references creates no concrete references
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}

-- OUTPUT -------------------------------------------------------------
<empty>

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-Referenced-By-P4MatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-Referenced-By-BuiltInField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-P4MatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-OptionalP4MatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-BuiltInMatchField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-To-P4ActionField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "some_action"
        parameter_name: "some_arg"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'some_action.some_arg', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-Referenced-By-BuiltInActionField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'multicast_group_id', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-P4ActionField reference creates a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "some_action"
        parameter_name: "some_arg"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'some_action.some_arg', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-BuiltInActionField reference creates a singleconcrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    action_field {
      built_in_action_field {
        action: BUILT_IN_ACTION_REPLICA
        parameter: BUILT_IN_PARAMETER_REPLICA_PORT
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi P4MatchField-Referenced-By-MatchField references create a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "some_other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
    ConcreteFieldReference{ source field: 'some_other_field', destination field: 'key2', value: 'key-b' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi P4MatchField-Referenced-By-MatchField including multiple optional references creates several concrete references.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field_1"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field_2"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field_1', destination field: 'key2', value: 'key-b' },
    ConcreteFieldReference{ source field: 'optional_field_2', destination field: 'key2', value: 'key-b' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field_1', destination field: 'key2', value: 'key-b' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field_2', destination field: 'key2', value: 'key-b' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi P4MatchField-Referenced-By-ActionField references from the same action create a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'key1', value: 'key-a' },
    ConcreteFieldReference{ source field: 'action.arg2', destination field: 'key2', value: 'key-b' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi P4MatchField-Referenced-By-ActionField references from different actions create a concrete reference for every action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_action.arg2', destination field: 'key2', value: 'key-b' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-Referenced-By-MatchField + Multi P4MatchField-Referenced-By-ActionField references from different actions create a concrete reference for every action plus an additional reference for match field only.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'key1', value: 'key-a' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_action.arg2', destination field: 'key2', value: 'key-b' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: P4MatchField-Referenced-By-OptionalMatchField + Multi P4MatchField-Referenced-By-ActionField references from different actions create a concrete reference for every action plus additional copies including and not including the optional.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
golden_test_friendly_table_entry {
  match {
    key1: "key-a"
    key2: "key-b"
  }
  action {
    golden_test_friendly_action {
      arg1: "arg1"
      arg2: "arg2"
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  p4_table {
    table_name: "golden_test_friendly_table"
    table_id: 50151603
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "optional_field"
        is_optional: true
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "source_action"
        parameter_name: "source_arg1"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key1"
        field_id: 1
      }
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_source_action"
        parameter_name: "source_arg2"
      }
    }
  }
  destination {
    match_field {
      p4_match_field {
        field_name: "key2"
        field_id: 2
      }
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field', destination field: 'key1', value: 'key-a' },
    ConcreteFieldReference{ source field: 'other_source_action.source_arg2', destination field: 'key2', value: 'key-b' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'optional_field', destination field: 'key1', value: 'key-a' },
    ConcreteFieldReference{ source field: 'source_action.source_arg1', destination field: 'key1', value: 'key-a' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_source_action.source_arg2', destination field: 'key2', value: 'key-b' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'golden_test_friendly_table'
  fields: {
    ConcreteFieldReference{ source field: 'source_action.source_arg1', destination field: 'key1', value: 'key-a' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi BuiltInMatchField-Referenced-By-MatchField references create a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "some_other_field"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'multicast_group_id', value: '7' },
    ConcreteFieldReference{ source field: 'some_other_field', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi BuiltInMatchField-Referenced-By-ActionField references from the same action create a single concrete reference.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'multicast_group_id', value: '7' },
    ConcreteFieldReference{ source field: 'action.arg2', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: Multi BuiltInMatchField-Referenced-By-ActionField references from different actions create a concrete reference for every action.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'multicast_group_id', value: '7' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_action.arg2', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
PossibleIncomingConcreteTableReferences: BuiltInMatchField-Referenced-By-MatchField + Multi BuiltInMatchField-Referenced-By-ActionField references from different actions create a concrete reference for every action plus an additional reference for match field only.
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entry --
multicast_group_table_entry {
  match {
    multicast_group_id: "0x0037"
  }
  action {
    replicate {
      replicas {
        port: "port"
        instance: "0x0031"
      }
    }
  }
}

-- ReferenceInfo --
source_table {
  p4_table {
    table_name: "other_table"
  }
}
destination_table {
  built_in_table: BUILT_IN_TABLE_MULTICAST_GROUP_TABLE
}
field_references {
  source {
    match_field {
      p4_match_field {
        field_name: "other_field"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "action"
        parameter_name: "arg1"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}
field_references {
  source {
    action_field {
      p4_action_field {
        action_name: "other_action"
        parameter_name: "arg2"
      }
    }
  }
  destination {
    match_field {
      built_in_match_field: BUILT_IN_MATCH_FIELD_MULTICAST_GROUP_ID
    }
  }
}

-- OUTPUT -------------------------------------------------------------
-- ReferenceEntries --
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'action.arg1', destination field: 'multicast_group_id', value: '7' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'multicast_group_id', value: '7' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_action.arg2', destination field: 'multicast_group_id', value: '7' },
    ConcreteFieldReference{ source field: 'other_field', destination field: 'multicast_group_id', value: '7' },
  }
}
ConcreteTableReference{
  source table: 'other_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'other_field', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
UnsatisfiedReferences: Unsatisfied reference
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entries --
entries {
  refers_to_multicast_by_action_table_entry {
    match {
      val: "dragon"
    }
    action {
      refers_to_multicast_action {
        multicast_group_id: "0x0037"
      }
    }
    controller_metadata: "Has unsatisfied reference"
  }
}

-- OUTPUT -------------------------------------------------------------
-- Entity with Unsatisfied References --
table_entry {
  table_id: 45367444
  match {
    field_id: 1
    exact {
      value: "dragon"
    }
  }
  action {
    action {
      action_id: 18598416
      params {
        param_id: 1
        value: "7"
      }
    }
  }
  metadata: "Has unsatisfied reference"
}
-- Unsatisfied References--
ConcreteTableReference{
  source table: 'refers_to_multicast_by_action_table'
  destination table: 'builtin::multicast_group_table'
  fields: {
    ConcreteFieldReference{ source field: 'refers_to_multicast_action.multicast_group_id', destination field: 'multicast_group_id', value: '7' },
  }
}

=========================================================================
UnsatisfiedReferences: Satisfied and unsatisfied references
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entries --
entries {
  refers_to_multicast_by_action_table_entry {
    match {
      val: "dragon"
    }
    action {
      refers_to_multicast_action {
        multicast_group_id: "0x0037"
      }
    }
    controller_metadata: "References satisfied"
  }
}
entries {
  multicast_group_table_entry {
    match {
      multicast_group_id: "0x0037"
    }
    action {
      replicate {
        replicas {
          port: "some_port"
          instance: "0x0031"
        }
      }
    }
    metadata: "Has unsatisfied reference"
  }
}

-- OUTPUT -------------------------------------------------------------
-- Entity with Unsatisfied References --
packet_replication_engine_entry {
  multicast_group_entry {
    multicast_group_id: 55
    replicas {
      instance: 49
      port: "some_port"
    }
    metadata: "Has unsatisfied reference"
  }
}
-- Unsatisfied References--
ConcreteTableReference{
  source table: 'builtin::multicast_group_table'
  destination table: 'referenced_by_multicast_replica_table'
  fields: {
    ConcreteFieldReference{ source field: 'replica.instance', destination field: 'instance', value: '1' },
    ConcreteFieldReference{ source field: 'replica.port', destination field: 'port', value: 'some_port' },
  }
}

=========================================================================
UnsatisfiedReferences: Satisfied references
=========================================================================
-- INPUT --------------------------------------------------------------
-- PD table entries --
entries {
  refers_to_multicast_by_action_table_entry {
    match {
      val: "dragon"
    }
    action {
      refers_to_multicast_action {
        multicast_group_id: "0x0037"
      }
    }
    controller_metadata: "References satisfied"
  }
}
entries {
  multicast_group_table_entry {
    match {
      multicast_group_id: "0x0037"
    }
    action {
      replicate {
        replicas {
          port: "some_port"
          instance: "0x0031"
        }
      }
    }
    metadata: "References satisfied"
  }
}
entries {
  referenced_by_multicast_replica_table_entry {
    match {
      port: "some_port"
      instance: "0x0031"
    }
    action {
      do_thing_4 {
      }
    }
    controller_metadata: "Has no references"
  }
}

-- OUTPUT -------------------------------------------------------------
<empty>
